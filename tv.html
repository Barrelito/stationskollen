<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stationsvy - AISAB TV</title>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { 
            background-color: #0f172a; 
            color: #f8fafc;
            font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
            overflow: hidden; 
            padding: 20px;
        }
        .tv-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* Tvinga 5 kolumner för arbetsveckan */
            gap: 15px;
            height: calc(100vh - 140px);
        }
        .day-card {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            flex-direction: column;
        }
        .task-row {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid #1e293b;
        }
        .task-row.done { opacity: 0.4; }
        .checkbox-tv {
            width: 24px; height: 24px;
            border-radius: 6px;
            border: 2px solid #facc15;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; margin-top: 2px;
        }
        .checkbox-tv.checked { background: #22c55e; border-color: #22c55e; }
        .task-text { font-size: 16px; font-weight: 500; line-height: 1.2; }
        .signer { font-size: 12px; color: #94a3b8; }
        .header-tv { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const CONFIG = {
            apiKey: "AIzaSyB8aujVryb93dqWxnQk2z3OOvgHQi5XY9A",
            authDomain: "stationssyor.firebaseapp.com",
            projectId: "stationssyor",
            storageBucket: "stationssyor.firebasestorage.app",
            messagingSenderId: "628579465876",
            appId: "1:628579465876:web:dc868450ef2e13e8b1d281"
        };

        if (!firebase.apps.length) firebase.initializeApp(CONFIG);
        const db = firebase.firestore();
        const auth = firebase.auth();

        function getISOWeek() {
            const d = new Date();
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            return Math.ceil((((d - new Date(d.getFullYear(), 0, 1)) / 86400000) + 1) / 7);
        }

        function StationTV() {
            const [tasks, setTasks] = useState([]);
            const [missed, setMissed] = useState([]);
            const [status, setStatus] = useState("Ansluter...");
            const [connected, setConnected] = useState(false);

            useEffect(() => {
                // VIKTIGT: Måste logga in för att få läsa från databasen
                auth.signInAnonymously()
                    .then(() => {
                        setStatus("Inloggad, hämtar data...");
                        const unsubscribe = db.collection('artifacts').doc('station-app')
                            .collection('public').doc('data').collection('chores').doc('current_state')
                            .onSnapshot(snapshot => {
                                if (snapshot.exists) {
                                    const data = snapshot.data();
                                    setTasks(data.tasks || []);
                                    setMissed(data.missedTasks || []);
                                    setConnected(true);
                                    setStatus("Live");
                                } else {
                                    setStatus("Ingen data hittades i databasen.");
                                }
                            }, err => {
                                setStatus("Fel vid hämtning: " + err.message);
                            });
                        return () => unsubscribe();
                    })
                    .catch(err => setStatus("Inloggningsfel: " + err.message));
            }, []);

            const tasksByDay = tasks.reduce((acc, task) => {
                if (task.isAdHoc) return acc;
                if (!acc[task.day]) acc[task.day] = [];
                acc[task.day].push(task);
                return acc;
            }, {});

            const days = ['Måndag', 'Tisdag', 'Onsdag', 'Torsdag', 'Fredag'];

            return (
                <div>
                    <div className="header-tv">
                        <div className="flex items-center gap-4">
                            <div className="bg-yellow-400 p-2 rounded-lg text-slate-900 font-black text-2xl">AISAB</div>
                            <div>
                                <h1 className="text-3xl font-bold tracking-tight">STATIONSSYSSLOR</h1>
                                <p className="text-yellow-400 font-bold">VECKA {getISOWeek()}</p>
                            </div>
                        </div>

                        <div className="flex gap-6 items-center">
                            {missed.filter(t => !t.done).length > 0 && (
                                <div className="bg-red-600 text-white px-4 py-2 rounded-lg font-bold animate-pulse text-sm">
                                    {missed.filter(t => !t.done).length} SLÄPANDE UPPGIFTER
                                </div>
                            )}
                            <div className="text-right">
                                <div className="text-2xl font-mono leading-none">{new Date().toLocaleTimeString('sv-SE', {hour: '2-digit', minute:'2-digit'})}</div>
                                <div className="text-slate-500 text-xs uppercase">{new Date().toLocaleDateString('sv-SE', {weekday: 'long', day: 'numeric', month: 'short'})}</div>
                            </div>
                        </div>
                    </div>

                    <div className="tv-grid">
                        {days.map(day => (
                            <div key={day} className="day-card">
                                <div className="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                                    <h2 className="text-xl font-bold text-yellow-500">{day}</h2>
                                    <span className="text-xs font-bold bg-slate-800 px-2 py-1 rounded text-slate-400">
                                        {tasksByDay[day]?.filter(t=>t.done).length || 0}/{tasksByDay[day]?.length || 0}
                                    </span>
                                </div>
                                <div className="overflow-hidden">
                                    {tasksByDay[day]?.map(task => (
                                        <div key={task.id} className={`task-row ${task.done ? 'done' : ''}`}>
                                            <div className={`checkbox-tv ${task.done ? 'checked' : ''}`}>
                                                {task.done && <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="4"><polyline points="20 6 9 17 4 12" /></svg>}
                                            </div>
                                            <div className="min-w-0">
                                                <div className="task-text truncate-2-lines">{task.text}</div>
                                                {task.signedBy && <div className="signer">✓ {task.signedBy}</div>}
                                            </div>
                                        </div>
                                    ))}
                                    {(!tasksByDay[day] || tasksByDay[day].length === 0) && <div className="text-slate-600 italic text-sm">Inga sysslor</div>}
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Felsökningsrad - kan tas bort när det fungerar */}
                    <div className="fixed bottom-2 left-4 text-[10px] text-slate-600 flex items-center">
                        <span className={`status-dot ${connected ? 'bg-green-500' : 'bg-red-500'}`}></span>
                        Status: {status}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StationTV />);
    </script>
</body>
</html>
