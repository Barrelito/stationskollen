<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Stationssysslor</title>
  
  <!-- 1. Hämta bibliotek (Återgår till de mest stabila CDN-länkarna) -->
  <script type="text/javascript" src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.min.js"></script>
  <script type="text/javascript" src="https://cdn.tailwindcss.com"></script>
  
  <!-- Firebase -->
  <script type="text/javascript" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; color: #1e293b; }
    .app-container { min-height: 100vh; padding-bottom: 80px; }
    
    /* LOGIN SCREEN */
    .login-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: #0f172a;
      display: flex; align-items: center; justify-content: center;
      padding: 20px; z-index: 100;
    }
    .login-card {
      background: white; width: 100%; max-width: 360px;
      border-radius: 24px; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
    }
    .login-header {
      background-color: #facc15; padding: 40px; display: flex; justify-content: center;
    }
    .login-body { padding: 32px; }
    .login-title { text-align: center; font-size: 24px; font-weight: bold; margin: 0 0 8px 0; color: #0f172a; }
    .login-subtitle { text-align: center; color: #64748b; margin-bottom: 24px; }
    .input-code {
      width: 100%; padding: 16px; font-size: 24px; text-align: center; letter-spacing: 4px;
      border: 2px solid #e2e8f0; border-radius: 12px; margin-bottom: 16px; outline: none;
    }
    .input-code:focus { border-color: #facc15; }
    .btn-primary {
      width: 100%; background-color: #0f172a; color: white; border: none;
      padding: 16px; border-radius: 12px; font-size: 16px; font-weight: bold;
      display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; transition: background 0.2s;
    }
    .btn-primary:hover { background-color: #1e293b; }
    .btn-secondary {
        width: 100%; background-color: #f1f5f9; color: #475569; border: none;
        padding: 12px; border-radius: 12px; font-size: 14px; font-weight: bold; cursor: pointer; margin-top: 8px;
    }
    .error-msg { color: #ef4444; text-align: center; font-size: 14px; margin-bottom: 12px; }

    /* ERROR BOX */
    #error-box {
      display: none; position: fixed; top: 0; left: 0; width: 100%; background: #fee2e2; color: #991b1b; padding: 20px; z-index: 9999; border-bottom: 2px solid #ef4444; font-family: monospace;
    }

    /* MAIN APP CSS */
    .header { background-color: #0f172a; color: white; position: sticky; top: 0; z-index: 50; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    .header-content { max-width: 800px; margin: 0 auto; padding: 16px; display: flex; align-items: center; justify-content: space-between; }
    .header-nav { display: flex; gap: 16px; }
    .nav-button {
        padding: 8px 12px; border-radius: 8px; font-weight: 500; cursor: pointer; transition: background 0.2s;
    }
    .nav-button.active { background-color: #1e293b; color: #facc15; }
    .nav-button:not(.active):hover { background-color: #1e293b; }

    .header-left { display: flex; align-items: center; gap: 12px; }
    .icon-box { background-color: #facc15; padding: 8px; border-radius: 8px; color: #0f172a; display: flex; }
    .header-title h1 { margin: 0; font-size: 18px; font-weight: bold; }
    .header-title p { margin: 0; font-size: 12px; color: #94a3b8; font-family: monospace; }
    .btn-text { background: none; border: none; color: #94a3b8; font-size: 12px; cursor: pointer; }
    
    .main-content { max-width: 800px; margin: 0 auto; padding: 16px; display: flex; flex-direction: column; gap: 24px; }
    
    /* Uppdaterad Demo Banner */
    .demo-banner { 
      background-color: #fff7ed; border: 1px solid #fed7aa; color: #c2410c; 
      padding: 12px; border-radius: 12px; font-size: 13px; text-align: center; 
      display: flex; flex-direction: column; align-items: center; gap: 4px; margin-bottom: 16px;
    }
    .demo-error-detail {
      font-size: 11px; font-family: monospace; background: rgba(0,0,0,0.05);
      padding: 4px 8px; border-radius: 4px; margin-top: 4px; word-break: break-all;
    }

    /* CARDS & TASKS */
    .card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
    .card-header { padding: 16px; background-color: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
    .card-title { margin: 0; font-size: 18px; font-weight: bold; color: #1e293b; display: flex; align-items: center; gap: 8px; }
    .task-list { display: flex; flex-direction: column; }
    .task-item { padding: 16px; display: flex; gap: 16px; align-items: flex-start; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: background 0.1s; }
    .task-item:last-child { border-bottom: none; }
    .task-item:hover { background-color: #f8fafc; }
    .task-item.done { background-color: rgba(34, 197, 94, 0.1); }
    .checkbox { width: 28px; height: 28px; border-radius: 50%; border: 2px solid #cbd5e1; display: flex; align-items: center; justify-content: center; flex-shrink: 0; background: white; }
    .task-item.done .checkbox { background-color: #22c55e; border-color: #22c55e; color: white; }
    .task-item.missed .checkbox { border-color: #fca5a5; }
    .task-text { flex: 1; }
    .task-label { font-size: 16px; font-weight: 500; color: #1e293b; margin: 0; line-height: 1.4; }
    .task-item.done .task-label { text-decoration: line-through; color: #94a3b8; }
    .meta-info { margin-top: 6px; display: flex; gap: 12px; font-size: 12px; align-items: center; }
    .signed-tag { display: inline-flex; align-items: center; gap: 4px; background-color: #dcfce7; color: #15803d; padding: 2px 8px; border-radius: 6px; font-weight: bold; }
    .missed-tag { background-color: #fee2e2; color: #b91c1c; padding: 2px 8px; border-radius: 6px; font-weight: bold; }
    .unsigned-text { color: #94a3b8; }
    .missed-card { border: 2px solid #fee2e2; background-color: #fef2f2; }
    .missed-header { background-color: #fee2e2; color: #991b1b; }
    .adhoc-header { background-color: #1e293b; color: white; }
    .adhoc-title { color: white; }

    /* MODAL */
    .modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; padding: 16px; z-index: 200; backdrop-filter: blur(4px); }
    .modal-card { background: white; width: 100%; max-width: 400px; border-radius: 16px; padding: 24px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); animation: popIn 0.2s ease-out; }
    @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .modal-title { margin: 0 0 8px 0; font-size: 20px; font-weight: bold; }
    .modal-text { color: #64748b; margin: 0 0 24px 0; }
    .input-name { width: 100%; padding: 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 18px; margin-bottom: 24px; outline: none; }
    .input-name:focus { border-color: #22c55e; }
    .modal-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .btn-cancel { background-color: #f1f5f9; color: #475569; border: none; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; }
    .btn-confirm { background-color: #22c55e; color: white; border: none; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; }
    .btn-confirm:disabled { opacity: 0.5; cursor: not-allowed; }
  </style>
</head>
<body>
  <div id="error-box"></div>
  <div id="root">
    <div style="display:flex;justify-content:center;align-items:center;height:100vh;color:#94a3b8;font-family:sans-serif;">
      Laddar stationen...
    </div>
  </div>

  <script>
    // NÖDBROMS: Fångar fel och visar dem på skärmen
    window.onerror = function(message, source, lineno, colno, error) {
      document.getElementById('error-box').style.display = 'block';
      document.getElementById('error-box').innerHTML = '<strong>Ett fel uppstod:</strong><br>' + message;
    };
  </script>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // --- 1. STARTA FIREBASE ---
    // HÄR ÄR DIN KONFIGURATION:
    const MANUAL_FIREBASE_CONFIG = {
      apiKey: "AIzaSyB8aujVryb93dqWxnQk2z3OOvgHQi5XY9A",
      authDomain: "stationssyor.firebaseapp.com",
      projectId: "stationssyor",
      storageBucket: "stationssyor.firebasestorage.app",
      messagingSenderId: "628579465876",
      appId: "1:628579465876:web:dc868450ef2e13e8b1d281",
      measurementId: "G-LN9XCK78SH"
    };

    // Initiera bara om det inte redan är gjort
    if (typeof firebase !== 'undefined' && !firebase.apps.length) {
      if (Object.keys(MANUAL_FIREBASE_CONFIG).length > 0) {
        firebase.initializeApp(MANUAL_FIREBASE_CONFIG);
      } else {
        console.warn("Ingen Firebase-konfiguration hittades. Appen körs i offline-demo.");
      }
    } else if (typeof firebase === 'undefined') {
      throw new Error("Firebase kunde inte laddas. Kontrollera din internetanslutning eller brandvägg.");
    }

    // --- ICONS ---
    const Ambulance = ({size=24, color="currentColor"}) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 10l6 0"/><path d="M13 7l0 6"/><path d="M19 14.286c0 1.257 -.416 2.404 -1.134 3.29c-1.134 1.401 -3.109 2.424 -5.866 2.424s-4.732 -1.023 -5.866 -2.423c-.718 -.887 -1.134 -2.034 -1.134 -3.291c0 -2.628 3.134 -4.286 7 -4.286s7 1.658 7 4.286z"/><path d="M5.029 14.652c.264 -2.607 1.83 -5.652 6.971 -5.652s6.707 3.045 6.971 5.652"/><path d="M5.006 12.396l-1.006 -2.396l2.164 -2.527a2.003 2.003 0 0 1 2.126 -.646l3.71 1.173l3.71 -1.173a2.003 2.003 0 0 1 2.126 .646l2.164 2.527l-1.006 2.396"/></svg>
    );
    const Lock = ({size=24, color="currentColor"}) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
    );
    const AlertTriangle = ({size=24, color="currentColor"}) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
    );
    const Calendar = ({size=24, color="currentColor"}) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
    );
    const CheckCircle2 = ({size=24, color="currentColor"}) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>
    );
    const User = ({size=24, color="currentColor"}) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
    );
    const History = ({size=24, color="currentColor"}) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>
    );
    const WifiOff = ({size=24, color="currentColor"}) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="2" x2="22" y1="2" y2="22"/><path d="M8.5 8.5A6 6 0 0 1 12 8a6 6 0 0 1 6 2"/><path d="M5 5.5A10 10 0 0 1 12 2a10 10 0 0 1 10 6.5"/><path d="M14.83 14.83a4 4 0 0 1-5.66 0"/><path d="M12 22v.01"/></svg>
    );

    // --- KONFIGURATION ---
    const STATION_PASSWORD = "112";
    const ADMIN_PASSWORD = "112"; // NYTT: Lösenord för Admin-läge

    const WEEKLY_TASKS_TEMPLATE = {
      Monday: [ 
        { id: 'mon_1', text: 'Kontroll av reservbil/Flexbil 9030', day: 'Måndag' },
      ],
      Tuesday: [
        { id: 'tue_1', text: 'Storrengöring ambulansen 9410', day: 'Tisdag' },
        { id: 'tue_2', text: 'Storrengöring ambulansen 9420', day: 'Tisdag' },
        { id: 'tue_3', text: 'Däckkontroll', day: 'Tisdag' },
      ],
      Wednesday: [
        { id: 'wed_1', text: 'Rengöring Tvätthall', day: 'Onsdag' },
        { id: 'wed_2', text: 'Rensa och rengöra båda kylskåpen, kasta omärkt mat', day: 'Onsdag' },
        { id: 'wed_3', text: 'Torka bänkar, dörrar, lådor, rengör mikrovågsugnar och kaffebryggare', day: 'Onsdag' },
        { id: 'wed_4', text: 'Storrengöring reservbil/Flexbil 9030', day: 'Onsdag' }, 
      ],
      Thursday: [
        { id: 'thu_1', text: 'Storkontroll av ambulans 9410 enl. packplan', day: 'Torsdag' },
        { id: 'thu_3', text: 'Storkontroll av ambulans 9420 enl. packplan', day: 'Torsdag' },
        { id: 'thu_2', text: 'Lägg sopsäckar i soptunnan i tvättstugan', day: 'Torsdag' },
      ],
      Friday: [
        { id: 'fri_1', text: 'Rengöring vagnhall', day: 'Fredag' },
      ],
      Saturday: [
        { id: 'sat_1', text: 'Provstarta 9030 (Endast Provstart)', day: 'Lördag' }, 
      ]
    };

    const ADHOC_TASKS_TEMPLATE = [ // Mall för Vid behov
      { id: 'ad_1', text: 'Tidningar (Släng/Sortera)', day: 'Vid behov' },
      { id: 'ad_2', text: 'Pantburkar', day: 'Vid behov' },
      { id: 'ad_3', text: 'Vattna blommor', day: 'Vid behov' },
      { id: 'ad_4', text: 'Hämta post i postfacket', day: 'Vid behov' },
    ];

    function getISOWeek(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      return Math.ceil((((d.getTime() - yearStart.getTime()) / 86400000) + 1) / 7);
    }

    function getWeekId() {
      const now = new Date();
      const year = now.getFullYear();
      const week = getISOWeek(now);
      return `${year}-W${week}`;
    }

    // Skapar en unik ID för nya, manuellt tillagda uppgifter
    function createNewId() {
        return 'custom_' + Date.now() + Math.random().toString(36).substring(2, 9);
    }

    // --- APP COMPONENT ---
    function StationChoresApp() {
      const [user, setUser] = useState(null);
      const [isUnlocked, setIsUnlocked] = useState(false);
      const [passwordInput, setPasswordInput] = useState("");
      const [loginError, setLoginError] = useState(false);
      const [tasks, setTasks] = useState([]);
      const [missedTasks, setMissedTasks] = useState([]);
      const [signingTask, setSigningTask] = useState(null);
      const [signerName, setSignerName] = useState("");
      const [isDemoMode, setIsDemoMode] = useState(false);
      const [demoError, setDemoError] = useState(""); 
      const [mode, setMode] = useState('user'); // 'user', 'admin', 'history'
      const [adminUnlocked, setAdminUnlocked] = useState(false); // NYTT: Adminlås
      
      const appId = 'station-app';
      
      const db = useMemo(() => {
        if (Object.keys(MANUAL_FIREBASE_CONFIG).length === 0) return null;
        return firebase.firestore();
      }, []);
      
      const auth = useMemo(() => {
        if (Object.keys(MANUAL_FIREBASE_CONFIG).length === 0) return null;
        return firebase.auth();
      }, []);

      useEffect(() => {
        // Hämta inloggningsstatus från local storage
        const savedSession = window.localStorage.getItem('station_unlocked');
        if (savedSession === 'true') setIsUnlocked(true);
        
        if (!auth) {
          setIsDemoMode(true);
          setDemoError("Ingen databaskoppling hittades (konfiguration saknas).");
          return;
        }

        const initAuth = async () => {
          try {
            await auth.signInAnonymously();
          } catch (err) {
            console.error("Auth failed:", err);
            setIsDemoMode(true);
            setDemoError("Inloggning misslyckades: " + err.message);
          }
        };
        initAuth();
        
        return auth.onAuthStateChanged((u) => {
          if (u) {
            setUser(u);
            setIsDemoMode(false);
            setDemoError("");
          }
        });
      }, [auth]);

      useEffect(() => {
        if (isDemoMode) {
          initializeLocalDemoData();
          return;
        }

        if (!user || !db) return;
        
        const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('chores').doc('current_state');

        const unsubscribe = docRef.onSnapshot(async (snapshot) => {
          const currentWeekId = getWeekId();
          
          if (!snapshot.exists) {
            await initializeNewWeek(docRef, currentWeekId, [], []);
          } else {
            const data = snapshot.data();
            // Lagra historisk data för att kunna bläddra
            if (data.weekId && data.tasks) {
                // Spara gamla listan innan vi eventuellt uppdaterar den
                await saveWeekHistory(data.weekId, data.tasks, data.missedTasks);
            }

            if (data.weekId !== currentWeekId) {
              const previousTasks = data.tasks || [];
              const notDone = previousTasks.filter((t) => !t.done && !t.isAdHoc);
              const oldMissed = data.missedTasks || [];
              const oldMissedStillNotDone = oldMissed.filter((t) => !t.done);
              
              const newMissedList = [...oldMissedStillNotDone, ...notDone.map((t) => ({
                ...t, originalWeek: data.weekId, isMissed: true
              }))];
              
              // Läs in den senaste listmallen från databasen (om den finns) annars använd koden.
              const templateDocRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('chores').doc('template');
              const templateSnapshot = await templateDocRef.get();
              let newTemplate = WEEKLY_TASKS_TEMPLATE;
              let newAdhoc = ADHOC_TASKS_TEMPLATE;

              if (templateSnapshot.exists) {
                  const templateData = templateSnapshot.data();
                  newTemplate = templateData.weeklyTasks || WEEKLY_TASKS_TEMPLATE;
                  newAdhoc = templateData.adhocTasks || ADHOC_TASKS_TEMPLATE;
              }

              await initializeNewWeek(docRef, currentWeekId, newMissedList, newTemplate, newAdhoc);

            } else {
              setTasks(data.tasks || []);
              setMissedTasks(data.missedTasks || []);
            }
          }
        }, (error) => {
          console.error("Error fetching tasks:", error);
          setIsDemoMode(true);
          setDemoError("Databasfel: " + error.message); 
          initializeLocalDemoData();
        });
        return () => unsubscribe();
      }, [user, isDemoMode, db, appId]);
      
      const saveWeekHistory = async (weekId, tasks, missedTasks) => {
          const historyRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('history').doc(weekId);
          const historySnapshot = await historyRef.get();
          // Spara bara om det är en ny vecka eller om det inte redan är sparat
          if (!historySnapshot.exists) {
              await historyRef.set({ tasks, missedTasks, savedAt: firebase.firestore.FieldValue.serverTimestamp() });
          }
      };

      const initializeLocalDemoData = () => {
        const freshTasks = [];
        Object.entries(WEEKLY_TASKS_TEMPLATE).forEach(([day, taskList]) => {
          taskList.forEach(task => freshTasks.push({ ...task, done: false, signedBy: '', completedAt: null, isAdHoc: false }));
        });
        ADHOC_TASKS_TEMPLATE.forEach(task => freshTasks.push({ ...task, done: false, signedBy: '', completedAt: null, isAdHoc: true }));
        setTasks(freshTasks);
        setMissedTasks([]); 
      };

      const initializeNewWeek = async (docRef, weekId, carryOverTasks, weeklyTemplate, adhocTemplate) => {
        const freshTasks = [];
        Object.entries(weeklyTemplate).forEach(([day, taskList]) => {
          taskList.forEach(task => freshTasks.push({ ...task, done: false, signedBy: '', completedAt: null, isAdHoc: false }));
        });
        adhocTemplate.forEach(task => freshTasks.push({ ...task, done: false, signedBy: '', completedAt: null, isAdHoc: true }));

        await docRef.set({ weekId: weekId, tasks: freshTasks, missedTasks: carryOverTasks, lastUpdated: firebase.firestore.FieldValue.serverTimestamp() });
      };

      const handleLogin = (e, is_admin = false) => {
        e.preventDefault();
        const requiredPassword = is_admin ? ADMIN_PASSWORD : STATION_PASSWORD;

        if (passwordInput === requiredPassword) {
          if (is_admin) {
             setAdminUnlocked(true);
             setMode('admin');
          } else {
             setIsUnlocked(true);
          }
          setLoginError(false);
          window.localStorage.setItem('station_unlocked', 'true');
        } else {
          setLoginError(true);
        }
      };
      
      const handleNavigation = (newMode) => {
          if (newMode === 'admin' && !adminUnlocked) {
              setMode('login_admin');
          } else if (newMode === 'history' && !adminUnlocked) {
              setMode('login_admin');
          } else {
              setMode(newMode);
          }
      };

      const startSigning = (taskId, listType) => {
        setSigningTask(`${listType}:${taskId}`);
        setSignerName("");
      };

      const confirmTask = async () => {
        if (!signingTask || !signerName.trim()) return;
        
        if (isDemoMode) {
          const [listType, taskId] = signingTask.split(':');
          const timestamp = new Date().toISOString();
          const updateList = (list) => list.map(t => 
            t.id === taskId ? { ...t, done: !t.done, signedBy: !t.done ? signerName : '', completedAt: !t.done ? timestamp : null } : t
          );
          if (listType === 'regular') setTasks(updateList(tasks));
          else setMissedTasks(updateList(missedTasks));
          
          setSigningTask(null);
          setSignerName("");
          return;
        }

        const [listType, taskId] = signingTask.split(':');
        const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('chores').doc('current_state');
        const timestamp = new Date().toISOString();

        const updateList = (list) => list.map(t => 
          t.id === taskId ? { ...t, done: !t.done, signedBy: !t.done ? signerName : '', completedAt: !t.done ? timestamp : null } : t
        );

        await docRef.update({
          tasks: listType === 'regular' ? updateList(tasks) : tasks,
          missedTasks: listType === 'missed' ? updateList(missedTasks) : missedTasks
        });

        setSigningTask(null);
        setSignerName("");
      };

      // --- Rendering av olika lägen ---
      
      if (!isUnlocked) {
        return (
          <div className="login-screen">
            <div className="login-card">
              <div className="login-header">
                <Ambulance size={64} color="#0f172a" />
              </div>
              <div className="login-body">
                <h1 className="login-title">Stationssysslor</h1>
                <p className="login-subtitle">Ange personal kod</p>
                <form onSubmit={handleLogin}>
                  <input
                    type="password"
                    inputMode="numeric"
                    value={passwordInput}
                    onChange={(e) => setPasswordInput(e.target.value)}
                    className="input-code"
                    placeholder="KOD"
                    autoFocus
                  />
                  {loginError && <p className="error-msg">Fel kod, försök igen.</p>}
                  <button type="submit" className="btn-primary">
                    <Lock size={18} /> Lås upp
                  </button>
                  <button onClick={() => setMode('login_admin')} className="btn-secondary">
                      Admin-inloggning
                  </button>
                </form>
              </div>
            </div>
          </div>
        );
      }

      // --- ADMIN LOGIN SCREEN ---
      if (mode === 'login_admin') {
          return (
              <div className="login-screen">
                  <div className="login-card">
                      <div className="login-header"><Lock size={64} color="#0f172a" /></div>
                      <div className="login-body">
                          <h1 className="login-title">Admin Inloggning</h1>
                          <p className="login-subtitle">Ange Admin-kod</p>
                          <form onSubmit={(e) => handleLogin(e, true)}>
                              <input type="password" inputMode="numeric" value={passwordInput} onChange={(e) => setPasswordInput(e.target.value)} className="input-code" placeholder="ADMIN KOD" autoFocus />
                              {loginError && <p className="error-msg">Fel kod, försök igen.</p>}
                              <button type="submit" className="btn-primary"><Lock size={18} /> Logga in som Admin</button>
                              <button onClick={() => setMode('user')} className="btn-secondary">Tillbaka till lista</button>
                          </form>
                      </div>
                  </div>
              </div>
          );
      }
      
      // --- ADMIN PANEL COMPONENT ---
      const AdminPanel = ({ db, appId, template, adhocTemplate, setMode, isDemoMode, user }) => {
          const [editableTasks, setEditableTasks] = useState(template);
          const [editableAdhoc, setEditableAdhoc] = useState(adhocTemplate);
          const [message, setMessage] = useState(null);
          const [newTaskText, setNewTaskText] = useState("");
          const [newTaskDay, setNewTaskDay] = useState("Monday");

          useEffect(() => {
              // Hämta mallen från databasen när komponenten laddas
              const loadTemplate = async () => {
                  if (isDemoMode) {
                     setEditableTasks(WEEKLY_TASKS_TEMPLATE);
                     setEditableAdhoc(ADHOC_TASKS_TEMPLATE);
                     return;
                  }
                  const templateDocRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('chores').doc('template');
                  const snapshot = await templateDocRef.get();
                  if (snapshot.exists) {
                      const data = snapshot.data();
                      setEditableTasks(data.weeklyTasks || WEEKLY_TASKS_TEMPLATE);
                      setEditableAdhoc(data.adhocTasks || ADHOC_TASKS_TEMPLATE);
                  } else {
                      // Spara mallen från koden om den inte finns i DB
                       const freshTasks = WEEKLY_TASKS_TEMPLATE;
                       const freshAdhoc = ADHOC_TASKS_TEMPLATE;
                       setEditableTasks(freshTasks);
                       setEditableAdhoc(freshAdhoc);
                       await templateDocRef.set({ weeklyTasks: freshTasks, adhocTasks: freshAdhoc, lastUpdated: firebase.firestore.FieldValue.serverTimestamp() });
                  }
              };
              loadTemplate();
          }, [db, appId, isDemoMode]);

          const saveTemplate = async () => {
              if (isDemoMode) {
                  setMessage({ type: 'error', text: 'Kan ej spara i demoläge.' });
                  return;
              }
              try {
                  const templateDocRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('chores').doc('template');
                  await templateDocRef.set({
                      weeklyTasks: editableTasks,
                      adhocTasks: editableAdhoc,
                      lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                      updatedBy: user.uid
                  });
                  setMessage({ type: 'success', text: 'Ny mall sparad! Ändringar träder i kraft nästa vecka (eller efter manuell reset).' });
              } catch (e) {
                  setMessage({ type: 'error', text: 'Kunde inte spara: ' + e.message });
              }
          };

          const addTask = () => {
              if (!newTaskText.trim()) return;
              const newItem = { id: createNewId(), text: newTaskText.trim(), day: newTaskDay };
              
              if (newTaskDay === 'Vid behov') {
                  setEditableAdhoc([...editableAdhoc, newItem]);
              } else {
                  setEditableTasks(prev => ({
                      ...prev,
                      [newTaskDay]: [...(prev[newTaskDay] || []), newItem]
                  }));
              }
              setNewTaskText('');
          };

          const removeTask = (day, id) => {
              if (day === 'Vid behov') {
                  setEditableAdhoc(prev => prev.filter(t => t.id !== id));
              } else {
                  setEditableTasks(prev => ({
                      ...prev,
                      [day]: prev[day].filter(t => t.id !== id)
                  }));
              }
          };

          const moveTask = (day, index, direction) => {
              const list = [...editableTasks[day]];
              const newIndex = index + direction;
              if (newIndex >= 0 && newIndex < list.length) {
                  const [movedItem] = list.splice(index, 1);
                  list.splice(newIndex, 0, movedItem);
                  setEditableTasks(prev => ({ ...prev, [day]: list }));
              }
          };


          return (
              <div style={{ padding: '16px', maxWidth: '800px', margin: '0 auto' }}>
                  <h2 style={{ fontSize: '24px', fontWeight: 'bold', marginBottom: '16px', borderBottom: '2px solid #ccc', paddingBottom: '8px' }}>Admin Panel - Listmall</h2>
                  
                  {message && (
                      <div style={{ padding: '12px', marginBottom: '16px', borderRadius: '8px', backgroundColor: message.type === 'success' ? '#dcfce7' : '#fee2e2', color: message.type === 'success' ? '#15803d' : '#991b1b' }}>
                          {message.text}
                      </div>
                  )}

                  <div className="card" style={{ marginBottom: '16px', padding: '16px' }}>
                      <h3 style={{ fontWeight: 'bold', fontSize: '18px', marginBottom: '8px' }}>Lägg till ny syssla</h3>
                      <select value={newTaskDay} onChange={(e) => setNewTaskDay(e.target.value)} style={{ padding: '8px', border: '1px solid #ccc', borderRadius: '4px', marginRight: '8px' }}>
                          {['Måndag', 'Tisdag', 'Onsdag', 'Torsdag', 'Fredag', 'Lördag', 'Vid behov'].map(day => (
                              <option key={day} value={day}>{day}</option>
                          ))}
                      </select>
                      <input 
                          type="text" 
                          value={newTaskText} 
                          onChange={(e) => setNewTaskText(e.target.value)} 
                          placeholder="Ny uppgiftstext"
                          style={{ padding: '8px', border: '1px solid #ccc', borderRadius: '4px', marginRight: '8px', width: '200px' }}
                      />
                      <button onClick={addTask} className="btn-primary" style={{ width: 'auto', padding: '8px 16px', fontSize: '14px' }}>Lägg till</button>
                  </div>
                  
                  <button onClick={saveTemplate} className="btn-primary" style={{ marginBottom: '24px', backgroundColor: '#10b981', hover: 'background-color: #059669' }}>
                      SPARA NY MALL (Gäller från nästa vecka)
                  </button>

                  {/* Redigera Veckosysslor */}
                  <h3 style={{ fontSize: '20px', fontWeight: 'bold', marginBottom: '12px' }}>Veckosysslor</h3>
                  {Object.keys(editableTasks).map(day => (
                      <div key={day} className="card" style={{ marginBottom: '12px' }}>
                          <div className="card-header" style={{ fontWeight: 'bold', fontSize: '16px' }}>{day}</div>
                          <div className="task-list">
                              {(editableTasks[day] || []).map((task, index) => (
                                  <div key={task.id} style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '8px 16px', borderBottom: '1px solid #eee' }}>
                                      <span style={{ flexGrow: 1 }}>{task.text}</span>
                                      <div style={{ display: 'flex', gap: '4px', marginRight: '8px' }}>
                                          <button onClick={() => moveTask(day, index, -1)} style={{ fontSize: '12px', padding: '2px 6px', border: '1px solid #ccc', borderRadius: '4px' }}>▲</button>
                                          <button onClick={() => moveTask(day, index, 1)} style={{ fontSize: '12px', padding: '2px 6px', border: '1px solid #ccc', borderRadius: '4px' }}>▼</button>
                                      </div>
                                      <button onClick={() => removeTask(day, task.id)} style={{ color: 'white', backgroundColor: '#ef4444', border: 'none', padding: '4px 8px', borderRadius: '4px', fontSize: '12px' }}>Ta bort</button>
                                  </div>
                              ))}
                          </div>
                      </div>
                  ))}

                  {/* Redigera Vid Behov */}
                  <h3 style={{ fontSize: '20px', fontWeight: 'bold', marginBottom: '12px', marginTop: '24px' }}>Vid behov / Övrigt</h3>
                  <div className="card">
                      <div className="task-list">
                           {editableAdhoc.map((task) => (
                              <div key={task.id} style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '8px 16px', borderBottom: '1px solid #eee' }}>
                                  <span style={{ flexGrow: 1 }}>{task.text}</span>
                                  <button onClick={() => removeTask('Vid behov', task.id)} style={{ color: 'white', backgroundColor: '#ef4444', border: 'none', padding: '4px 8px', borderRadius: '4px', fontSize: '12px' }}>Ta bort</button>
                              </div>
                          ))}
                      </div>
                  </div>
              </div>
          );
      };

      // --- HISTORY COMPONENT ---
      const HistoryPanel = ({ db, appId, isDemoMode }) => {
          const [historyList, setHistoryList] = useState([]);
          const [selectedWeek, setSelectedWeek] = useState(null);
          const [tasks, setTasks] = useState([]);

          useEffect(() => {
              if (isDemoMode) {
                  setHistoryList([{ id: '2024-W40', date: '2024-10-01', summary: 'Demodata: 5/10 klarade.' }]);
                  return;
              }

              const fetchHistory = async () => {
                  // Hämta historik dokument-ID:n
                  const historyCollectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('history');
                  const snapshot = await historyCollectionRef.get();
                  const list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                  list.sort((a, b) => b.id.localeCompare(a.id)); // Senaste först
                  setHistoryList(list.slice(0, 10)); // Visa bara de 10 senaste
              };
              fetchHistory();
          }, [db, appId, isDemoMode]);

          useEffect(() => {
              if (!selectedWeek || isDemoMode) {
                  setTasks([]);
                  return;
              }
              const fetchWeekData = async () => {
                  const historyDocRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('history').doc(selectedWeek);
                  const snapshot = await historyDocRef.get();
                  if (snapshot.exists) {
                      setTasks(snapshot.data().tasks || []);
                  }
              };
              fetchWeekData();
          }, [selectedWeek, db, appId, isDemoMode]);
          
          const tasksByDay = tasks.reduce((acc, task) => {
              if (!acc[task.day]) acc[task.day] = [];
              acc[task.day].push(task);
              return acc;
          }, {});

          return (
              <div style={{ padding: '16px', maxWidth: '800px', margin: '0 auto' }}>
                  <h2 style={{ fontSize: '24px', fontWeight: 'bold', marginBottom: '16px', borderBottom: '2px solid #ccc', paddingBottom: '8px' }}>Historik - Genomförda Veckor</h2>
                  
                  <select value={selectedWeek || ''} onChange={(e) => setSelectedWeek(e.target.value)} style={{ padding: '8px', border: '1px solid #ccc', borderRadius: '4px', marginBottom: '24px', width: '100%' }}>
                      <option value="">Välj vecka att granska...</option>
                      {historyList.map(week => (
                          <option key={week.id} value={week.id}>
                              {week.id} (Sparad {week.savedAt?.toDate().toLocaleDateString('sv-SE')})
                          </option>
                      ))}
                  </select>

                  {selectedWeek && tasks.length > 0 && (
                      <div className="card" style={{ padding: '16px', marginBottom: '16px' }}>
                           <h3 style={{ fontWeight: 'bold', fontSize: '20px', marginBottom: '12px' }}>Genomförande vecka {selectedWeek}</h3>
                           {Object.keys(tasksByDay).map(day => (
                                <div key={day} style={{ marginBottom: '12px' }}>
                                    <h4 style={{ fontWeight: 'bold', color: '#1e293b', marginBottom: '4px' }}>{day}</h4>
                                    <ul style={{ listStyle: 'none', padding: '0' }}>
                                        {tasksByDay[day].map(task => (
                                            <li key={task.id} style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0', borderBottom: '1px dotted #eee', fontSize: '14px' }}>
                                                <span>{task.text}</span>
                                                <span style={{ color: task.done ? '#22c55e' : '#ef4444', fontWeight: 'bold' }}>
                                                    {task.done ? `KLART (${task.signedBy || '?'})` : 'EJ KLART'}
                                                </span>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                           ))}
                      </div>
                  )}
                  {isDemoMode && <p style={{color: '#c2410c'}}>Historik är begränsad till demo-data i detta läge.</p>}
              </div>
          );
      };
      
      // --- VÄLJ VILKEN VY SOM SKA VISAS ---

      let content;
      if (mode === 'admin') {
          content = <AdminPanel db={db} appId={appId} template={WEEKLY_TASKS_TEMPLATE} adhocTemplate={ADHOC_TASKS_TEMPLATE} setMode={setMode} isDemoMode={isDemoMode} user={user} />;
      } else if (mode === 'history') {
          content = <HistoryPanel db={db} appId={appId} isDemoMode={isDemoMode} />;
      } else {
          // Standard USER VIEW
          const tasksByDay = tasks.reduce((acc, task) => {
            if (task.isAdHoc) return acc;
            if (!acc[task.day]) acc[task.day] = [];
            acc[task.day].push(task);
            return acc;
          }, {});
          
          const orderedDays = ['Måndag', 'Tisdag', 'Onsdag', 'Torsdag', 'Fredag', 'Lördag'];
          const visibleDays = orderedDays.filter(day => tasksByDay[day] && tasksByDay[day].length > 0);

          const adHocTasks = tasks.filter((t) => t.isAdHoc);
          
          content = (
              <main className="main-content">
                  {/* SLÄPANDE SYSSLOR */}
                  {missedTasks.length > 0 && (
                    <div className="card missed-card">
                      <div className="card-header missed-header">
                        <h2 className="card-title" style={{color: '#991b1b'}}>
                          <AlertTriangle size={20} /> Släpande sysslor
                        </h2>
                      </div>
                      <div className="task-list">
                        {missedTasks.map((task) => (
                          <TaskItem key={task.id} task={task} onToggle={() => task.done ? null : startSigning(task.id, 'missed')} isMissed={true} />
                        ))}
                      </div>
                    </div>
                  )}

                  {/* DAGAR */}
                  {visibleDays.map((day) => (
                    <div key={day} className="card">
                      <div className="card-header">
                        <h2 className="card-title">
                          <Calendar size={18} color="#eab308" /> {day}
                        </h2>
                        <span style={{fontSize: '12px', color: '#94a3b8', background: '#f1f5f9', padding: '2px 8px', borderRadius: '12px'}}>
                          {tasksByDay[day]?.filter((t) => t.done).length || 0} / {tasksByDay[day]?.length || 0}
                        </span>
                      </div>
                      <div className="task-list">
                        {tasksByDay[day]?.map((task) => (
                          <TaskItem 
                            key={task.id} 
                            task={task} 
                            onToggle={() => {
                              if(task.done) { setSigningTask(`regular:${task.id}`); setSignerName(""); } 
                              else { startSigning(task.id, 'regular'); }
                            }} 
                          />
                        ))}
                        {tasksByDay[day]?.length === 0 && <div style={{padding:'16px', color:'#cbd5e1', fontStyle:'italic'}}>Inga sysslor.</div>}
                      </div>
                    </div>
                  ))}
                  
                  {/* Söndag - FRI AKTIVITET */}
                  {(!tasksByDay['Lördag'] || tasksByDay['Lördag'].length === 0) && (
                       <div key="Söndag" className="card">
                          <div className="card-header">
                             <h2 className="card-title">
                               <Calendar size={18} color="#22c55e" /> Lördag & Söndag
                             </h2>
                          </div>
                          <div className="task-list">
                             <div style={{padding:'16px', color:'#22c55e', fontStyle:'italic', fontWeight:'bold'}}>
                                FRI AKTIVITET (Hela helgen är ledig från fasta stationssysslor!)
                             </div>
                          </div>
                        </div>
                  )}

                  {/* ÖVRIGT */}
                  <div className="card" style={{borderColor: '#1e293b'}}>
                    <div className="card-header adhoc-header">
                      <h2 className="card-title adhoc-title">
                        <History size={18} color="#facc15" /> Vid behov / Övrigt
                      </h2>
                    </div>
                    <div className="task-list">
                      {adHocTasks.map((task) => (
                        <TaskItem key={task.id} task={task} onToggle={() => startSigning(task.id, 'regular')} />
                      ))}
                    </div>
                  </div>
              </main>
          );
      }
      // --- SLUT VÄLJ VILKEN VY SOM SKA VISAS ---
      

      return (
        <div className="app-container">
          
          {/* MODAL */}
          {signingTask && (
            <div className="modal-overlay">
              <div className="modal-card">
                <h3 className="modal-title">Signera utförd syssla</h3>
                <p className="modal-text">Vem är det som checkar av detta?</p>
                <input
                  type="text"
                  value={signerName}
                  onChange={(e) => setSignerName(e.target.value)}
                  placeholder="Ditt förnamn"
                  className="input-name"
                  autoFocus
                />
                <div className="modal-actions">
                  <button onClick={() => setSigningTask(null)} className="btn-cancel">Avbryt</button>
                  <button onClick={confirmTask} disabled={!signerName.trim()} className="btn-confirm">Klart!</button>
                </div>
              </div>
            </div>
          )}

          {/* HEADER */}
          <header className="header">
            <div className="header-content">
              <div className="header-left">
                <div className="icon-box"><Ambulance size={24} /></div>
                <div className="header-title">
                  <h1>Stationssysslor</h1>
                  <p>Vecka {getISOWeek(new Date())}</p>
                </div>
              </div>
              
              <div className="header-nav" style={{ marginRight: '16px' }}>
                  <div 
                      className={`nav-button ${mode === 'user' ? 'active' : ''}`} 
                      onClick={() => handleNavigation('user')}
                  >
                      Lista
                  </div>
                  <div 
                      className={`nav-button ${mode === 'admin' ? 'active' : ''}`} 
                      onClick={() => handleNavigation('admin')}
                  >
                      Admin
                  </div>
                  <div 
                      className={`nav-button ${mode === 'history' ? 'active' : ''}`} 
                      onClick={() => handleNavigation('history')}
                  >
                      Historik
                  </div>
              </div>

              <button onClick={() => { 
                setIsUnlocked(false); 
                setAdminUnlocked(false); 
                setMode('user');
                window.localStorage.removeItem('station_unlocked'); 
              }} className="btn-text">
                Lås
              </button>
            </div>
          </header>

          {/* DEMO MODE BANNER */}
          {isDemoMode && (
            <div className="demo-banner">
              <div style={{display:'flex', alignItems:'center', gap:'8px'}}>
                <WifiOff size={16} />
                <strong>Demoläge - Ändringar sparas ej</strong>
              </div>
              {demoError && <div className="demo-error-detail">{demoError}</div>}
            </div>
          )}

          {content}
        </div>
      );
    }

    function TaskItem({ task, onToggle, isMissed = false }) {
      return (
        <div className={`task-item ${task.done ? 'done' : ''} ${isMissed ? 'missed' : ''}`} onClick={onToggle}>
          <div className="checkbox">
            {task.done && <CheckCircle2 size={18} />}
          </div>
          <div className="task-text">
            <p className="task-label">{task.text}</p>
            <div className="meta-info">
              {task.signedBy ? (
                <span className="signed-tag"><User size={12} /> {task.signedBy}</span>
              ) : (
                <span className="unsigned-text">Ej signerad</span>
              )}
              {isMissed && !task.done && <span className="missed-tag">Släpar</span>}
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<StationChoresApp />);
  </script>
</body>
</html>