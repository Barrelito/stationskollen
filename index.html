import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  collection, 
  doc, 
  onSnapshot, 
  updateDoc, 
  setDoc, 
  Timestamp 
} from 'firebase/firestore';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  CheckCircle2, 
  AlertTriangle, 
  Calendar, 
  User, 
  Ambulance, 
  History,
  Lock,
  X
} from 'lucide-react';

// --- STYLES (CSS) ---
// Denna CSS gör att appen ser snygg ut utan extra installationer
const appStyles = `
  * { box-sizing: border-box; }
  body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; color: #1e293b; }
  
  .app-container { min-height: 100vh; padding-bottom: 80px; }
  
  /* LOGIN SCREEN */
  .login-screen {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: #0f172a;
    display: flex; align-items: center; justify-content: center;
    padding: 20px; z-index: 100;
  }
  .login-card {
    background: white; width: 100%; max-width: 360px;
    border-radius: 24px; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
  }
  .login-header {
    background-color: #facc15; padding: 40px; display: flex; justify-content: center;
  }
  .login-body { padding: 32px; }
  .login-title { text-align: center; font-size: 24px; font-weight: bold; margin: 0 0 8px 0; color: #0f172a; }
  .login-subtitle { text-align: center; color: #64748b; margin-bottom: 24px; }
  .input-code {
    width: 100%; padding: 16px; font-size: 24px; text-align: center; letter-spacing: 4px;
    border: 2px solid #e2e8f0; border-radius: 12px; margin-bottom: 16px; outline: none;
  }
  .input-code:focus { border-color: #facc15; }
  .btn-primary {
    width: 100%; background-color: #0f172a; color: white; border: none;
    padding: 16px; border-radius: 12px; font-size: 16px; font-weight: bold;
    display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer;
  }
  .btn-primary:hover { background-color: #1e293b; }
  .error-msg { color: #ef4444; text-align: center; font-size: 14px; margin-bottom: 12px; }

  /* MAIN APP */
  .header {
    background-color: #0f172a; color: white; position: sticky; top: 0; z-index: 50;
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
  }
  .header-content {
    max-width: 800px; margin: 0 auto; padding: 16px;
    display: flex; align-items: center; justify-content: space-between;
  }
  .header-left { display: flex; align-items: center; gap: 12px; }
  .icon-box { background-color: #facc15; padding: 8px; border-radius: 8px; color: #0f172a; display: flex; }
  .header-title h1 { margin: 0; font-size: 18px; font-weight: bold; }
  .header-title p { margin: 0; font-size: 12px; color: #94a3b8; font-family: monospace; }
  .btn-text { background: none; border: none; color: #94a3b8; font-size: 12px; cursor: pointer; }
  
  .main-content { max-width: 800px; margin: 0 auto; padding: 16px; display: flex; flex-direction: column; gap: 24px; }

  /* CARDS */
  .card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
  .card-header { padding: 16px; background-color: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
  .card-title { margin: 0; font-size: 18px; font-weight: bold; color: #1e293b; display: flex; align-items: center; gap: 8px; }
  
  /* TASK ITEMS */
  .task-list { display: flex; flex-direction: column; }
  .task-item {
    padding: 16px; display: flex; gap: 16px; align-items: flex-start;
    border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: background 0.1s;
  }
  .task-item:last-child { border-bottom: none; }
  .task-item:hover { background-color: #f8fafc; }
  .task-item.done { background-color: rgba(34, 197, 94, 0.1); }
  
  .checkbox {
    width: 28px; height: 28px; border-radius: 50%; border: 2px solid #cbd5e1;
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    background: white;
  }
  .task-item.done .checkbox { background-color: #22c55e; border-color: #22c55e; color: white; }
  .task-item.missed .checkbox { border-color: #fca5a5; }
  
  .task-text { flex: 1; }
  .task-label { font-size: 16px; font-weight: 500; color: #1e293b; margin: 0; line-height: 1.4; }
  .task-item.done .task-label { text-decoration: line-through; color: #94a3b8; }
  
  .meta-info { margin-top: 6px; display: flex; gap: 12px; font-size: 12px; align-items: center; }
  .signed-tag {
    display: inline-flex; align-items: center; gap: 4px; 
    background-color: #dcfce7; color: #15803d; padding: 2px 8px; 
    border-radius: 6px; font-weight: bold;
  }
  .missed-tag {
    background-color: #fee2e2; color: #b91c1c; padding: 2px 8px;
    border-radius: 6px; font-weight: bold;
  }
  .unsigned-text { color: #94a3b8; }

  /* MISSED TASKS CARD */
  .missed-card { border: 2px solid #fee2e2; background-color: #fef2f2; }
  .missed-header { background-color: #fee2e2; color: #991b1b; }

  /* ADHOC CARD */
  .adhoc-header { background-color: #1e293b; color: white; }
  .adhoc-title { color: white; }

  /* MODAL */
  .modal-overlay {
    position: fixed; inset: 0; background-color: rgba(0,0,0,0.6);
    display: flex; align-items: center; justify-content: center; padding: 16px; z-index: 200;
    backdrop-filter: blur(4px);
  }
  .modal-card {
    background: white; width: 100%; max-width: 400px; border-radius: 16px;
    padding: 24px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
    animation: popIn 0.2s ease-out;
  }
  @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  
  .modal-title { margin: 0 0 8px 0; font-size: 20px; font-weight: bold; }
  .modal-text { color: #64748b; margin: 0 0 24px 0; }
  .input-name {
    width: 100%; padding: 16px; border: 2px solid #e2e8f0; border-radius: 12px;
    font-size: 18px; margin-bottom: 24px; outline: none;
  }
  .input-name:focus { border-color: #22c55e; }
  .modal-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .btn-cancel {
    background-color: #f1f5f9; color: #475569; border: none; padding: 12px;
    border-radius: 12px; font-weight: bold; cursor: pointer;
  }
  .btn-confirm {
    background-color: #22c55e; color: white; border: none; padding: 12px;
    border-radius: 12px; font-weight: bold; cursor: pointer;
  }
  .btn-confirm:disabled { opacity: 0.5; cursor: not-allowed; }
`;

// --- KONFIGURATION ---
const STATION_PASSWORD = "112"; 

const WEEKLY_TASKS_TEMPLATE = {
  Tuesday: [
    { id: 'tue_1', text: 'Storrengöring ambulansen 9410', day: 'Tisdag' },
    { id: 'tue_2', text: 'Storrengöring ambulansen 9420', day: 'Tisdag' },
    { id: 'tue_3', text: 'Däckkontroll', day: 'Tisdag' },
  ],
  Wednesday: [
    { id: 'wed_1', text: 'Rengöring Tvätthall', day: 'Onsdag' },
    { id: 'wed_2', text: 'Rensa och rengöra båda kylskåpen, kasta omärkt mat', day: 'Onsdag' },
    { id: 'wed_3', text: 'Torka bänkar, dörrar, lådor, rengör mikrovågsugnar och kaffebryggare', day: 'Onsdag' },
  ],
  Thursday: [
    { id: 'thu_1', text: 'Storkontroll av ambulanserna 9410 & 9420 enl. packplan', day: 'Torsdag' },
    { id: 'thu_2', text: 'Lägg sopsäckar i soptunnan i tvättstugan', day: 'Torsdag' },
  ],
  Friday: [
    { id: 'fri_1', text: 'Rengöring vagnhall', day: 'Fredag' },
  ],
  Saturday: [
    { id: 'sat_1', text: 'Kontrollera och städa reservbil/Flexbil 9030', day: 'Lördag' },
    { id: 'sat_2', text: 'Provstarta 9030', day: 'Lördag' },
    { id: 'sat_3', text: 'Tanka 9030 vid ½ tank', day: 'Lördag' },
  ]
};

const ADHOC_TASKS = [
  { id: 'ad_1', text: 'Tidningar (Släng/Sortera)', day: 'Vid behov' },
  { id: 'ad_2', text: 'Pantburkar', day: 'Vid behov' },
  { id: 'ad_3', text: 'Vattna blommor', day: 'Vid behov' },
  { id: 'ad_4', text: 'Hämta post i postfacket', day: 'Vid behov' },
];

function getISOWeek(date: Date) {
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
  return Math.ceil((((d.getTime() - yearStart.getTime()) / 86400000) + 1) / 7);
}

function getWeekId() {
  const now = new Date();
  const year = now.getFullYear();
  const week = getISOWeek(now);
  return `${year}-W${week}`;
}

export default function StationChoresApp() {
  const [user, setUser] = useState<any>(null);
  const [isUnlocked, setIsUnlocked] = useState(false);
  const [passwordInput, setPasswordInput] = useState("");
  const [loginError, setLoginError] = useState(false);
  const [tasks, setTasks] = useState<any[]>([]);
  const [missedTasks, setMissedTasks] = useState<any[]>([]);
  const [signingTask, setSigningTask] = useState<string | null>(null);
  const [signerName, setSignerName] = useState("");

  const firebaseConfig = JSON.parse(process.env.REACT_APP_FIREBASE_CONFIG || '{}');
  const configToUse = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'station-app';

  const app = useMemo(() => initializeApp(configToUse), [configToUse]);
  const auth = useMemo(() => getAuth(app), [app]);
  const db = useMemo(() => getFirestore(app), [app]);

  useEffect(() => {
    signInAnonymously(auth);
    const savedSession = localStorage.getItem('station_unlocked');
    if (savedSession === 'true') setIsUnlocked(true);
    return onAuthStateChanged(auth, setUser);
  }, [auth]);

  useEffect(() => {
    if (!user) return;
    const docRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'chores'), 'current_state');

    const unsubscribe = onSnapshot(docRef, async (snapshot) => {
      const currentWeekId = getWeekId();
      
      if (!snapshot.exists()) {
        await initializeNewWeek(docRef, currentWeekId, [], []);
      } else {
        const data = snapshot.data();
        if (data.weekId !== currentWeekId) {
          const previousTasks = data.tasks || [];
          const notDone = previousTasks.filter((t: any) => !t.done && !t.isAdHoc);
          const oldMissed = data.missedTasks || [];
          const oldMissedStillNotDone = oldMissed.filter((t: any) => !t.done);
          
          const newMissedList = [...oldMissedStillNotDone, ...notDone.map((t: any) => ({
            ...t, originalWeek: data.weekId, isMissed: true
          }))];

          await initializeNewWeek(docRef, currentWeekId, newMissedList, []);
        } else {
          setTasks(data.tasks || []);
          setMissedTasks(data.missedTasks || []);
        }
      }
    });
    return () => unsubscribe();
  }, [user, db, appId]);

  const initializeNewWeek = async (docRef: any, weekId: string, carryOverTasks: any[], existingAdHoc: any[]) => {
    const freshTasks: any[] = [];
    Object.entries(WEEKLY_TASKS_TEMPLATE).forEach(([day, taskList]) => {
      taskList.forEach(task => freshTasks.push({ ...task, done: false, signedBy: '', completedAt: null, isAdHoc: false }));
    });
    ADHOC_TASKS.forEach(task => freshTasks.push({ ...task, done: false, signedBy: '', completedAt: null, isAdHoc: true }));

    await setDoc(docRef, { weekId: weekId, tasks: freshTasks, missedTasks: carryOverTasks, lastUpdated: Timestamp.now() });
  };

  const handleLogin = (e: React.FormEvent) => {
    e.preventDefault();
    if (passwordInput === STATION_PASSWORD) {
      setIsUnlocked(true);
      setLoginError(false);
      localStorage.setItem('station_unlocked', 'true');
    } else {
      setLoginError(true);
    }
  };

  const startSigning = (taskId: string, listType: 'regular' | 'missed') => {
    setSigningTask(`${listType}:${taskId}`);
    setSignerName("");
  };

  const confirmTask = async () => {
    if (!signingTask || !signerName.trim()) return;
    const [listType, taskId] = signingTask.split(':');
    const docRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'chores'), 'current_state');
    const timestamp = new Date().toISOString();

    const updateList = (list: any[]) => list.map(t => 
      t.id === taskId ? { ...t, done: !t.done, signedBy: !t.done ? signerName : '', completedAt: !t.done ? timestamp : null } : t
    );

    await updateDoc(docRef, {
      tasks: listType === 'regular' ? updateList(tasks) : tasks,
      missedTasks: listType === 'missed' ? updateList(missedTasks) : missedTasks
    });

    setSigningTask(null);
    setSignerName("");
  };

  if (!isUnlocked) {
    return (
      <>
        <style>{appStyles}</style>
        <div className="login-screen">
          <div className="login-card">
            <div className="login-header">
              <Ambulance size={64} color="#0f172a" />
            </div>
            <div className="login-body">
              <h1 className="login-title">Stationssysslor</h1>
              <p className="login-subtitle">Ange stationskod</p>
              <form onSubmit={handleLogin}>
                <input
                  type="password"
                  inputMode="numeric"
                  value={passwordInput}
                  onChange={(e) => setPasswordInput(e.target.value)}
                  className="input-code"
                  placeholder="KOD"
                  autoFocus
                />
                {loginError && <p className="error-msg">Fel kod, försök igen.</p>}
                <button type="submit" className="btn-primary">
                  <Lock size={18} /> Lås upp
                </button>
              </form>
            </div>
          </div>
        </div>
      </>
    );
  }

  const tasksByDay = tasks.reduce((acc: any, task: any) => {
    if (task.isAdHoc) return acc;
    if (!acc[task.day]) acc[task.day] = [];
    acc[task.day].push(task);
    return acc;
  }, {});

  const adHocTasks = tasks.filter((t: any) => t.isAdHoc);

  return (
    <div className="app-container">
      <style>{appStyles}</style>

      {/* MODAL */}
      {signingTask && (
        <div className="modal-overlay">
          <div className="modal-card">
            <h3 className="modal-title">Signera utförd syssla</h3>
            <p className="modal-text">Vem är det som checkar av detta?</p>
            <input
              type="text"
              value={signerName}
              onChange={(e) => setSignerName(e.target.value)}
              placeholder="Ditt förnamn"
              className="input-name"
              autoFocus
            />
            <div className="modal-actions">
              <button onClick={() => setSigningTask(null)} className="btn-cancel">Avbryt</button>
              <button onClick={confirmTask} disabled={!signerName.trim()} className="btn-confirm">Klart!</button>
            </div>
          </div>
        </div>
      )}

      {/* HEADER */}
      <header className="header">
        <div className="header-content">
          <div className="header-left">
            <div className="icon-box"><Ambulance size={24} /></div>
            <div className="header-title">
              <h1>Stationssysslor</h1>
              <p>Vecka {getISOWeek(new Date())}</p>
            </div>
          </div>
          <button onClick={() => { setIsUnlocked(false); localStorage.removeItem('station_unlocked'); }} className="btn-text">
            Lås
          </button>
        </div>
      </header>

      <main className="main-content">
        
        {/* SLÄPANDE SYSSLOR */}
        {missedTasks.length > 0 && (
          <div className="card missed-card">
            <div className="card-header missed-header">
              <h2 className="card-title" style={{color: '#991b1b'}}>
                <AlertTriangle size={20} /> Släpande sysslor
              </h2>
            </div>
            <div className="task-list">
              {missedTasks.map((task) => (
                <TaskItem key={task.id} task={task} onToggle={() => task.done ? null : startSigning(task.id, 'missed')} isMissed={true} />
              ))}
            </div>
          </div>
        )}

        {/* DAGAR */}
        {['Tisdag', 'Onsdag', 'Torsdag', 'Fredag', 'Lördag'].map((day) => (
          <div key={day} className="card">
            <div className="card-header">
              <h2 className="card-title">
                <Calendar size={18} color="#eab308" /> {day}
              </h2>
              <span style={{fontSize: '12px', color: '#94a3b8', background: '#f1f5f9', padding: '2px 8px', borderRadius: '12px'}}>
                {tasksByDay[day]?.filter((t:any) => t.done).length || 0} / {tasksByDay[day]?.length || 0}
              </span>
            </div>
            <div className="task-list">
              {tasksByDay[day]?.map((task: any) => (
                <TaskItem 
                  key={task.id} 
                  task={task} 
                  onToggle={() => {
                    if(task.done) { setSigningTask(`regular:${task.id}`); setSignerName(""); } // Quick undo prep
                    else { startSigning(task.id, 'regular'); }
                  }} 
                />
              ))}
              {!tasksByDay[day] && <div style={{padding:'16px', color:'#cbd5e1', fontStyle:'italic'}}>Inga sysslor.</div>}
            </div>
          </div>
        ))}

        {/* ÖVRIGT */}
        <div className="card" style={{borderColor: '#1e293b'}}>
          <div className="card-header adhoc-header">
            <h2 className="card-title adhoc-title">
              <History size={18} color="#facc15" /> Vid behov / Övrigt
            </h2>
          </div>
          <div className="task-list">
            {adHocTasks.map((task: any) => (
              <TaskItem key={task.id} task={task} onToggle={() => startSigning(task.id, 'regular')} />
            ))}
          </div>
        </div>
      </main>
    </div>
  );
}

function TaskItem({ task, onToggle, isMissed = false }: any) {
  return (
    <div className={`task-item ${task.done ? 'done' : ''} ${isMissed ? 'missed' : ''}`} onClick={onToggle}>
      <div className="checkbox">
        {task.done && <CheckCircle2 size={18} />}
      </div>
      <div className="task-text">
        <p className="task-label">{task.text}</p>
        <div className="meta-info">
          {task.signedBy ? (
            <span className="signed-tag"><User size={12} /> {task.signedBy}</span>
          ) : (
            <span className="unsigned-text">Ej signerad</span>
          )}
          {isMissed && !task.done && <span className="missed-tag">Släpar</span>}
        </div>
      </div>
    </div>
  );
}
